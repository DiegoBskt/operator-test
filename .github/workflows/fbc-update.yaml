name: FBC Auto-Update

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Operator version to add to catalogs (e.g., v1.1.0)"
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  update-catalogs:
    name: Update FBC Catalogs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Convert image name to lowercase
        id: lowercase
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          SEMVER="${VERSION#v}"
          echo "semver=$SEMVER" >> $GITHUB_OUTPUT

      - name: Install opm
        run: |
          OPM_VERSION="v1.36.0"
          curl -Lo opm "https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm"
          chmod +x opm
          sudo mv opm /usr/local/bin/

      - name: Update catalog templates
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE_IMG="${{ env.REGISTRY }}/${{ steps.lowercase.outputs.image_name }}-bundle:${VERSION}"

          echo "Updating catalog templates for version: $VERSION"

          for template in catalog-templates/v4.*.yaml; do
            echo "Updating $template..."
            sed -i "s/cluster-assessment-operator.v[0-9]*\.[0-9]*\.[0-9]*/cluster-assessment-operator.${VERSION}/g" "$template"
            sed -i "s|ghcr.io/diegobskt/cluster-assessment-operator-bundle:v[0-9]*\.[0-9]*\.[0-9]*|${BUNDLE_IMG}|g" "$template"
          done

      - name: Regenerate FBC catalogs
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE_IMG="${{ env.REGISTRY }}/${{ steps.lowercase.outputs.image_name }}-bundle:${VERSION}"
          SEMVER="${VERSION#v}"

          for version in v4.12 v4.13 v4.14 v4.15 v4.16 v4.17 v4.18 v4.19 v4.20; do
            if [ -f "catalog-templates/$version.yaml" ]; then
              echo "Regenerating catalog for $version..."
              mkdir -p "catalogs/$version/cluster-assessment-operator"
              
              # Create catalog with proper FBC structure using printf
              CATALOG_FILE="catalogs/$version/cluster-assessment-operator/catalog.yaml"
              printf '%s\n' "---" > "$CATALOG_FILE"
              printf '%s\n' "schema: olm.package" >> "$CATALOG_FILE"
              printf '%s\n' "name: cluster-assessment-operator" >> "$CATALOG_FILE"
              printf '%s\n' "defaultChannel: stable-v1" >> "$CATALOG_FILE"
              printf '%s\n' "---" >> "$CATALOG_FILE"
              printf '%s\n' "schema: olm.channel" >> "$CATALOG_FILE"
              printf '%s\n' "name: stable-v1" >> "$CATALOG_FILE"
              printf '%s\n' "package: cluster-assessment-operator" >> "$CATALOG_FILE"
              printf '%s\n' "entries:" >> "$CATALOG_FILE"
              printf '%s\n' "  - name: cluster-assessment-operator.${VERSION}" >> "$CATALOG_FILE"
              printf '%s\n' "---" >> "$CATALOG_FILE"
              printf '%s\n' "schema: olm.channel" >> "$CATALOG_FILE"
              printf '%s\n' "name: candidate-v1" >> "$CATALOG_FILE"
              printf '%s\n' "package: cluster-assessment-operator" >> "$CATALOG_FILE"
              printf '%s\n' "entries:" >> "$CATALOG_FILE"
              printf '%s\n' "  - name: cluster-assessment-operator.${VERSION}" >> "$CATALOG_FILE"
              printf '%s\n' "---" >> "$CATALOG_FILE"
              printf '%s\n' "schema: olm.bundle" >> "$CATALOG_FILE"
              printf '%s\n' "name: cluster-assessment-operator.${VERSION}" >> "$CATALOG_FILE"
              printf '%s\n' "package: cluster-assessment-operator" >> "$CATALOG_FILE"
              printf '%s\n' "image: ${BUNDLE_IMG}" >> "$CATALOG_FILE"
              printf '%s\n' "properties:" >> "$CATALOG_FILE"
              printf '%s\n' "  - type: olm.package" >> "$CATALOG_FILE"
              printf '%s\n' "    value:" >> "$CATALOG_FILE"
              printf '%s\n' "      packageName: cluster-assessment-operator" >> "$CATALOG_FILE"
              printf '%s\n' "      version: \"${SEMVER}\"" >> "$CATALOG_FILE"
            fi
          done

      - name: Validate updated catalogs
        run: |
          echo "Validating all updated catalogs..."
          FAILED=0
          for version in v4.12 v4.13 v4.14 v4.15 v4.16 v4.17 v4.18 v4.19 v4.20; do
            if [ -d "catalogs/$version" ]; then
              if opm validate "catalogs/$version"; then
                echo "✓ $version validated"
              else
                echo "✗ $version failed validation"
                FAILED=1
              fi
            fi
          done
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          commit-message: "chore: update FBC catalogs for ${{ steps.version.outputs.version }}"
          title: "Update FBC catalogs for ${{ steps.version.outputs.version }}"
          body: |
            This PR automatically updates the File Based Catalog (FBC) configurations for operator version `${{ steps.version.outputs.version }}`.

            ## Changes
            - Updated catalog templates in `catalog-templates/`
            - Regenerated catalogs in `catalogs/` for all OCP versions (v4.12-v4.20)

            ## Validation
            All catalogs have been validated with `opm validate`.
          branch: fbc-update/${{ steps.version.outputs.version }}
          delete-branch: true
          labels: |
            automation
            fbc
            catalog
